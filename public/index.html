<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIè€ç…§ç‰‡ä¿®å¤ - RunningHub</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen flex flex-col items-center justify-center p-6 text-center">
    <h1 class="text-2xl font-semibold mb-2">AI è€ç…§ç‰‡ä¿®å¤ä½“éªŒç«™</h1>
    <p class="text-gray-600 mb-2">ä¸Šä¼ ä¸€å¼ è€ç…§ç‰‡ï¼ŒAI å°†å¸®ä½ ä¿®å¤å®ƒã€‚</p>
    <p class="text-xs text-gray-400 mb-4">Powered by RunningHub API</p>

    <!-- è´¦æˆ·ä½™é¢æ˜¾ç¤º -->
    <div id="balance" class="mb-4 text-sm text-gray-500 bg-white px-4 py-2 rounded-lg shadow-sm hidden"></div>

    <!-- ä¸Šä¼ åŒºåŸŸ -->
    <div
      id="uploadArea"
      class="border-2 border-dashed border-gray-300 rounded-xl p-8 bg-white w-full max-w-md cursor-pointer hover:border-blue-400"
    >
      <input
        type="file"
        id="fileInput"
        accept="image/*"
        class="hidden"
      />
      <div id="previewContainer">
        <p class="text-gray-400">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</p>
      </div>
    </div>

    <!-- ä¿®å¤æŒ‰é’® -->
    <button
      id="restoreBtn"
      disabled
      class="mt-6 px-6 py-3 rounded-lg text-white text-lg bg-gray-400 cursor-not-allowed"
    >
      é€‰æ‹©å›¾ç‰‡åå¼€å§‹
    </button>

    <!-- é”™è¯¯ä¿¡æ¯ -->
    <p id="errorMsg" class="text-red-500 mt-4 hidden"></p>

    <!-- ä¿®å¤åå›¾ç‰‡ -->
    <div id="resultContainer" class="mt-8 hidden">
      <h2 class="text-xl font-medium mb-3">âœ… ä¿®å¤å®Œæˆ</h2>
      <img id="resultImage" class="rounded-lg shadow-md max-h-80 mx-auto" />

      <!-- ä»»åŠ¡ä¿¡æ¯ -->
      <div id="taskInfo" class="mt-4 text-sm text-gray-600 bg-white px-4 py-2 rounded-lg inline-block"></div>

      <!-- ä¸‹è½½æŒ‰é’® -->
      <div class="mt-4">
        <a
          id="downloadBtn"
          href="#"
          download="restored-photo.png"
          target="_blank"
          class="inline-block px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
        >
          ä¸‹è½½ä¿®å¤åçš„å›¾ç‰‡
        </a>
      </div>
    </div>

    <!-- è°ƒè¯•ä¿¡æ¯ -->
    <div id="debugInfo" class="mt-10 bg-gray-100 text-left p-4 rounded-lg w-full max-w-2xl overflow-auto text-sm hidden">
      <h3 class="text-lg font-semibold mb-2 text-gray-700">ğŸ” è°ƒè¯•ä¿¡æ¯</h3>
      <pre id="debugContent" class="whitespace-pre-wrap break-words text-gray-800"></pre>
    </div>
  </div>

  <script>
    // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œè‡ªåŠ¨é€‚é…éƒ¨ç½²åŸŸå
    const API_URL = "/api/restore";
    const BALANCE_URL = "/api/balance";

    let selectedFile = null;

    // åŠ è½½ä½™é¢
    async function loadBalance() {
      try {
        const response = await fetch(BALANCE_URL);
        const data = await response.json();
        if (data.success) {
          const balanceEl = document.getElementById('balance');
          balanceEl.innerHTML = `ğŸ’° ä½™é¢: ${data.data.remainCoins} RHå¸ + ${data.data.remainMoney} ${data.data.currency} | ğŸ“Š API: ${data.data.apiType}`;
          balanceEl.classList.remove('hidden');
        }
      } catch (error) {
        console.error('è·å–ä½™é¢å¤±è´¥:', error);
      }
    }

    // æ–‡ä»¶é€‰æ‹©
    document.getElementById('uploadArea').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      selectedFile = file;

      const reader = new FileReader();
      reader.onload = (ev) => {
        document.getElementById('previewContainer').innerHTML =
          `<img src="${ev.target.result}" alt="é¢„è§ˆå›¾" class="rounded-lg max-h-64 mx-auto" />`;

        const btn = document.getElementById('restoreBtn');
        btn.disabled = false;
        btn.className = "mt-6 px-6 py-3 rounded-lg text-white text-lg bg-blue-600 hover:bg-blue-700";
        btn.textContent = "å¼€å§‹ä¿®å¤";
      };
      reader.readAsDataURL(file);
    });

    // ä¿®å¤æŒ‰é’®
    document.getElementById('restoreBtn').addEventListener('click', async () => {
      if (!selectedFile) return;

      const btn = document.getElementById('restoreBtn');
      btn.disabled = true;
      btn.className = "mt-6 px-6 py-3 rounded-lg text-white text-lg bg-gray-400 cursor-not-allowed";
      btn.textContent = "ğŸª„ æ­£åœ¨ä¿®å¤ä¸­...";

      document.getElementById('errorMsg').classList.add('hidden');
      document.getElementById('resultContainer').classList.add('hidden');

      try {
        // è½¬æ¢ä¸º Base64
        const reader = new FileReader();
        const base64Data = await new Promise((resolve) => {
          reader.onloadend = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(selectedFile);
        });

        console.log('ğŸ“¤ æ­£åœ¨ä¸Šä¼ è‡³ API...');

        // è°ƒç”¨API
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: base64Data })
        });

        const data = await response.json();
        console.log('ğŸ“© API è¿”å›ï¼š', data);

        if (!response.ok) throw new Error(data.error || 'æœåŠ¡å™¨é”™è¯¯');

        if (data.output_url) {
          // æ˜¾ç¤ºç»“æœ
          document.getElementById('resultImage').src = data.output_url;
          document.getElementById('downloadBtn').href = data.output_url;

          document.getElementById('taskInfo').innerHTML =
            `<span class="mr-3">ğŸ“ ä»»åŠ¡ID: ${data.taskId}</span>` +
            `<span class="mr-3">ğŸ’° æ¶ˆè´¹: ${data.consumeMoney}å…ƒ</span>` +
            `<span>â±ï¸ è€—æ—¶: ${data.taskCostTime}ç§’</span>`;

          document.getElementById('resultContainer').classList.remove('hidden');

          // åˆ·æ–°ä½™é¢
          loadBalance();

          // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
          if (data.debug_raw) {
            document.getElementById('debugContent').textContent = JSON.stringify(data.debug_raw, null, 2);
            document.getElementById('debugInfo').classList.remove('hidden');
          }
        } else {
          throw new Error('ä¿®å¤æˆåŠŸï¼Œä½†æœªè¿”å›å›¾ç‰‡é“¾æ¥');
        }

        btn.textContent = "ä¿®å¤å®Œæˆ";
      } catch (error) {
        console.error('âŒ å‡ºé”™ï¼š', error);
        const errorEl = document.getElementById('errorMsg');
        errorEl.textContent = error.message || 'ä¿®å¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
        errorEl.classList.remove('hidden');

        btn.disabled = false;
        btn.className = "mt-6 px-6 py-3 rounded-lg text-white text-lg bg-blue-600 hover:bg-blue-700";
        btn.textContent = "é‡è¯•";
      }
    });

    // åˆå§‹åŒ–
    loadBalance();
  </script>
</body>
</html>
